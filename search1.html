<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å—äºŒğŸ¦…è¡¨å–®å¡«å¯«ç´€éŒ„ğŸ¦…</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(to bottom right, #f9f9f9, #e6f7ff);
      color: #333;
      padding: 40px 20px;
      margin: 0;
      text-align: center;
    }
    h1 {
      font-size: 1.8em;
      margin-bottom: 30px;
      color: #3c6478;
    }
    .card {
      background-color: white;
      max-width: 500px;
      margin: auto;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }
    select, button {
      width: 90%;
      max-width: 400px;
      margin: 10px auto;
      padding: 10px 15px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 8px;
      outline: none;
      transition: border-color 0.3s ease;
    }
    select:focus, button:focus {
      border-color: #47a7f5;
    }
    button {
      background-color: #47a7f5;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    button:disabled {
      background-color: #a9d0fb;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background-color: #358ddb;
    }
    ul#result {
      list-style: none;
      padding: 0;
      margin-top: 20px;
    }
    ul#result li {
      padding: 8px;
      margin: 6px auto;
      max-width: 400px;
      border-radius: 8px;
      background-color: #f1f8ff;
      border-left: 6px solid #47a7f5;
    }
  </style>
</head>
<body>
  <h1>
    <a href="index.html" style="text-decoration: none; color: inherit;">
      ğŸ¦… è’é‡ä¿è­·å”æœƒè¦ªå­åœ˜å—äºŒåœ˜ï¼ˆç¿”é·¹ï¼‰ğŸ¦…
    </a>
  </h1>
  <h1>ğŸ“‹ æŸ¥è©¢è¡¨å–®å¡«å¯«ç´€éŒ„</h1>

   <div class="card">
    <select id="group" onchange="updateTypeOptions()">
      <option value="">è«‹é¸æ“‡é¡åˆ¥</option>
      <option value="eagle">ğŸ¦… é·¹ ğŸ¦…</option>
    </select>

    <select id="type" onchange="updateUserOptions()" disabled>
      <option value="">è«‹å…ˆé¸æ“‡ä¸Šæ–¹é¡åˆ¥</option>
    </select>

    <select id="username" disabled>
      <option value="">è«‹å…ˆé¸æ“‡é¡å‹</option>
    </select>

    <!-- âœ… é è¨­ disabled -->
    <button id="searchButton" onclick="checkAllForms()" disabled>æŸ¥è©¢</button>

    <div id="loading" style="margin-top: 20px; font-size: 1.1em; color: #888;"></div>
    <ul id="result"></ul>
  </div>

  <!-- ä½ çš„åœ˜å“¡åå–®ï¼Œéœ€åœ¨å…¶ä¸­å®šç¾© userOptions ç‰©ä»¶ -->
  <script src="https://sowtnn02.github.io/home/team-data.js"></script>

  <script>
    // 2. å»ºç«‹è½‰æ›å‡½å¼ï¼šå°‡ teamData (æ–°ç‰©ä»¶æ ¼å¼) è‡ªå‹•è½‰ç‚º userOptions (èˆŠå­—ä¸²æ ¼å¼)
    // é€™æ¨£ä¸‹æ–¹çš„æŸ¥è©¢é‚è¼¯å®Œå…¨ä¸ç”¨å‹•
    var userOptions = {};

    if (typeof teamData !== 'undefined') {
      // éæ­·æ‰€æœ‰åœ˜åˆ¥ (ant, bee, deer, eagle...)
      for (var groupKey in teamData) {
        userOptions[groupKey] = {};
        
        // ç‚ºäº†ç¶­æŒé¸å–®æ“ä½œé«”é©—ï¼ŒåŠ å…¥ä¸€å€‹ç©ºçš„é è¨­é¸é … (è®“ç¬¬äºŒå€‹é¸å–®é è¨­ä¸é¸å–)
        userOptions[groupKey][""] = [];

        // éæ­·è©²åœ˜åº•ä¸‹çš„æ‰€æœ‰åˆ†éšŠ (ex: å°é»‘èŸ», æ³¥å£ºèœ‚...)
        var subGroups = teamData[groupKey];
        for (var subGroupName in subGroups) {
          // map: åªæŠ“å– family (å®¶åº­åç¨±) æ¬„ä½ï¼Œè½‰æˆç´”å­—ä¸²é™£åˆ—
          userOptions[groupKey][subGroupName] = subGroups[subGroupName].map(function(member) {
            return member.family;
          });
        }
      }
      console.log("âœ… åå–®è¼‰å…¥æˆåŠŸï¼", userOptions);
    } else {
      alert("âš ï¸ ç„¡æ³•è®€å–åå–®è³‡æ–™ï¼Œè«‹æª¢æŸ¥ https://sowtnn02.github.io/home/team-data.js æ˜¯å¦å­˜åœ¨ã€‚");
    }
  </script>

<script>
    // ğŸ”´ 1. è¨­å®šä½ çš„ GAS ç¶²å€
    const MY_PROXY_URL = "https://script.google.com/macros/s/AKfycbxmzTs-dGe8rlGjeaUJH44bravhTNccqFsfImSz_wV-bSniF-E1aOqZ6nyShvyVYAtFCQ/exec";

    // ğŸ”´ 2. è¨­å®šä½ çš„ä¸»è³‡æ–™åº« ID (å·²æ›´æ–°ç‚ºæ–°è¡¨å–®)
    const MASTER_DB_ID = "1rsQZORmQldGeco9YRNUn9jaO10ogvXpsVSqjk4Z8Ur0"; 

    // -------------- è®€å–ä¸»è³‡æ–™åº« (æ–°ç‰ˆ Proxy) --------------
    async function loadSheetsFromSheet() {
      // ğŸŸ¢ é–å®šè®€å– "é·¹" åˆ†é 
      const masterSheetName = "é·¹"; 
      const url = `${MY_PROXY_URL}?targetId=${MASTER_DB_ID}&sheetName=${encodeURIComponent(masterSheetName)}`;

      try {
        const res = await fetch(url);
        const raw = await res.json();
        
        if (raw.error) {
          console.error("Master DB Error:", raw);
          alert("ç„¡æ³•è®€å–ä¸»è³‡æ–™åº«åˆ—è¡¨ï¼Œè«‹æª¢æŸ¥ GAS éƒ¨ç½²");
          return [];
        }

        // --- ğŸŸ¢ æ–°å¢ï¼šæ—¥æœŸéæ¿¾é‚è¼¯ ---
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const validData = raw.filter(item => {
           // 1. æª¢æŸ¥ä¸Šæ¶æ—¥
           if (item.date) {
             const startDate = new Date(item.date);
             startDate.setHours(0, 0, 0, 0);
             if (startDate > today) return false; 
           }
           // 2. æª¢æŸ¥ä¸‹æ¶æ—¥
           if (item.expiryDate) {
             const endDate = new Date(item.expiryDate);
             endDate.setHours(0, 0, 0, 0);
             if (endDate < today) return false; 
           }
           return true;
        });

        // è½‰æ›æ ¼å¼
        return validData.map(item => ({
          name: `${item['month'] || ''} ${item['title'] || ''}`, 
          url: toMyProxyUrl(item['response_url']) 
        }));

      } catch (e) {
        console.error("Load Sheets Error:", e);
        alert("è®€å–ä¸»è¡¨ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message);
        return [];
      }
    }

    // è½‰æ›é€£çµå‡½å¼
    function toMyProxyUrl(originalUrl) {
      if (!originalUrl) return "";
      const match = originalUrl.match(/\/d\/(.*?)(\/|$)/);
      const targetId = match ? match[1] : "";
      if (!targetId) return "";
      const targetSheetName = "è¡¨å–®å›æ‡‰ 1"; 
      return `${MY_PROXY_URL}?targetId=${targetId}&sheetName=${encodeURIComponent(targetSheetName)}`;
    }

    // ... (ä»¥ä¸‹ç¶­æŒåŸæœ¬çš„é¸å–®èˆ‡æŸ¥è©¢é‚è¼¯ï¼Œç„¡éœ€è®Šå‹•) ...
    
    // -------------- é¸å–®é‚è¼¯ --------------
    function updateTypeOptions() {
      const groupVal = document.getElementById("group").value;
      const typeSelect = document.getElementById("type");
      const userSelect = document.getElementById("username");
      const searchButton = document.getElementById("searchButton");

      typeSelect.innerHTML = "";
      userSelect.innerHTML = "";
      userSelect.disabled = true;
      searchButton.disabled = true;

      if (groupVal && userOptions[groupVal]) {
        typeSelect.disabled = false;
        Object.keys(userOptions[groupVal]).forEach(type => {
          const opt = new Option(type, type);
          typeSelect.appendChild(opt);
        });
        typeSelect.selectedIndex = 0;
        updateUserOptions();
      } else {
        typeSelect.disabled = true;
        typeSelect.appendChild(new Option("è«‹å…ˆé¸æ“‡ä¸Šæ–¹é¡åˆ¥", ""));
      }
    }

    function updateUserOptions() {
      const groupVal = document.getElementById("group").value;
      const typeVal  = document.getElementById("type").value;
      const userSelect = document.getElementById("username");
      const searchButton = document.getElementById("searchButton");

      userSelect.innerHTML = "";
      searchButton.disabled = true;

      if (groupVal && typeVal && userOptions[groupVal][typeVal]) {
        userSelect.disabled = false;
        userOptions[groupVal][typeVal].forEach(user => {
          userSelect.appendChild(new Option(user, user));
        });
        userSelect.selectedIndex = 0;
        searchButton.disabled = false;
      } else {
        userSelect.disabled = true;
        userSelect.appendChild(new Option("è«‹å…ˆé¸æ“‡é¡å‹", ""));
      }
    }

    // -------------- æŸ¥è©¢é‚è¼¯ --------------
    function fetchWithTimeout(url, t = 8000) { 
      return Promise.race([
        fetch(url),
        new Promise((_, rej) => setTimeout(() => rej(new Error("Timeout")), t))
      ]);
    }

    async function checkAllForms() {
      const name = document.getElementById("username").value.trim();
      const resultList = document.getElementById("result");
      const loading = document.getElementById("loading");

      if (!name) {
        alert("è«‹é¸æ“‡åœ˜åˆ¥ã€éšŠåˆ¥èˆ‡å®¶åº­åç¨±å¾Œå†æŸ¥è©¢ï¼");
        return;
      }

      resultList.innerHTML = "";
      loading.textContent = "ğŸ” æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™...";
      
      const sheets = await loadSheetsFromSheet();
      
      if (sheets.length === 0) {
        loading.textContent = "âš ï¸ æ‰¾ä¸åˆ°ä»»ä½•è¡¨å–®ç´€éŒ„ï¼Œæˆ–æ˜¯ç›®å‰ç„¡é–‹æ”¾çš„è¡¨å–®ã€‚";
        return;
      }

      for (const sheet of sheets) {
        const li = document.createElement("li");
        
        if (!sheet.url || sheet.url.includes("targetId=&")) {
             continue; 
        }

        try {
          const res = await fetchWithTimeout(sheet.url + "&t=" + Date.now(), 8000);
          
          if (!res.ok) throw new Error("API å›å‚³éŒ¯èª¤");

          const data = await res.json();
          const matched = data.filter(row =>
            Object.values(row)[1] && Object.values(row)[1].includes(name)
          );

          if (matched.length) {
            li.innerHTML = `<strong>${sheet.name}ï¼šâœ… æœ‰å¡«å¯«</strong><br/>`;
            matched.forEach((row, i) => {
              const v = Object.values(row);
              const entries = [];
              for (let j = 0; j < 3; j++) {
                const colA = v[2 + j*3];
                const colB = v[3 + j*3];
                const colC = v[4 + j*3];
                if (colA || colB || colC) {
                  entries.push(`${colB || ''} ${colA || ''} ${colC || ''}`);
                }
              }
              if (entries.length === 0 && v.length > 2) {
                   entries.push(v.slice(2,5).join(" "));
              }
              
              if (entries.length) li.innerHTML += `ğŸ“ å…§å®¹ï¼š${entries.join("ã€")}<br/>`;
            });
          } else {
            li.textContent = `${sheet.name}ï¼šâŒ ç„¡ç´€éŒ„`;
          }
        } catch (err) {
          console.error(sheet.name, err);
          li.textContent = `${sheet.name}ï¼šâš ï¸ æŸ¥è©¢å¤±æ•—ï¼ˆ${err.message === "Timeout" ? "é€£ç·šé€¾æ™‚" : "ç„¡æ³•è®€å–"}ï¼‰`;
        }
        resultList.appendChild(li);
      }
      loading.textContent = "";
    }
  </script>
</body>
</html>
